{% extends "template.html" %}

{% load tags %}
{% load filters %}
{% load wrapwith %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load survey_tags %}

{% block head %}
  {% include "popup_image.html" %}

  <script language="javascript">

   {% if target.celery_id %}

   var update_timer = 0;
   var update_timeout = 3000;

   update = function(){
     // Update target state (processing stage)
     $.ajax({
       url: "{% url 'target_state' target.id %}",
       dataType: "json",
       timeout: 3000,

       success: function(json){
         // Update state text
         $('#target_state').html(json.state);

         // Update state color class
         var stateElem = $('#target_state');
         stateElem.removeClass('text-danger text-primary text-success');
         if(json.state.includes('failed')){
           stateElem.addClass('text-danger');
         } else if(json.celery_id){
           stateElem.addClass('text-primary');
         } else {
           stateElem.addClass('text-success');
         }

         // Reload if task finished
         if(!json.celery_id){
           location.reload();
         }
       }
     });

     // Update celery task state
     $.ajax({
       url: "{% url 'queue_state' target.celery_id %}",
       dataType: "json",
       timeout: 3000,

       success: function(json){
         $('#celery_state').html(json.state);
         if(json.state == 'SUCCESS' || json.state == 'FAILURE' || json.state == 'REVOKED'){
           location.reload();
         }
       },

       complete: function(xhr, status) {
         setTimeout(update, update_timeout);
       }
     });
   }

   $(function(){
     setTimeout(update, update_timeout);
   });

   {% endif %}

  </script>
{% endblock %}

{% block ptitle %}
  {% if target.celery_id %}(Running){% endif %}
  Target {{ target.id }} : LCServer
{% endblock %}

{% block title_div %}{% endblock %}

{% block content %}

  {% if not target %}
    <p>Target not found</p>
  {% else %}

    <h2>
      {{ target.name }}
    </h2>

    {% if target.title %}
    <div class="fst-italic mb-2">
      {{ target.title }}
    </div>
    {% endif %}
    <div>
      <a href="{% url 'target_files' id=target.id %}" class="text-decoration-none text-body" title="Browse task files">
        <i class="fa fa-folder-open"></i>
      </a>
      Target {{ target.id }} created by <span class="text-primary fw-bold">{{ target.user|user }}</span> on {{ target.created|timestamp }} - {{ target.created|naturaltime }}
      {% if not user_may_submit %}
        <br>
        <span class="text-danger fw-bold">Target is read-only</span>
      {% endif %}
    </div>
    <div class="mb-4 {% if target.celery_id %}sticky-top bg-white border-bottom pb-2{% endif %}">
      State:
      {% if target.celery_id %}
        <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
      {% endif %}
      <b id="target_state" class="text-{% if target.state == 'failed' %}danger{% elif target.celery_id %}primary{% else %}success{% endif %}">{{ target.state }}</b> on {{ target.modified|timestamp }} - {{ target.modified|naturaltime }}
      {% if target.celery_id and user_may_submit %}
        <!-- Help popover -->
        <div class="span-help-popover d-inline float-end" title="Target is running">
          <p>
            The target processing task is running on the server. The page will be automatically re-loaded when processing is finished.
          </p>
          <p>
            If necessary, you may cancel the running task by clicking on the running task id and using corresponding button on the task page.
          </p>
        </div>

        <br>
        Running id:
        <a href="{% url 'queue' id=target.celery_id %}">{{ target.celery_id }}</a>
        (<span id="celery_state"></span>)
        {% if user_may_submit and False %}
          <form action="{% url 'queue' id=target.celery_id %}" method="POST">
            {% csrf_token %}
            <button type="submit" name="action" value="terminatetarget" class="btn btn-danger">Terminate</button>
          </form>
        {% endif %}
      {% endif %}
    </div>

    <hr>
    <h3>Basic info</h3>

    {% if user_may_submit %}
      <form action="" method="POST" class="mb-2">
        <fieldset class="small" {% if target.celery_id %}disabled{% endif %}>
          {% crispy form_target_info %}

          <button type="submit" name="action" value="target_info" class="btn btn-primary">Get info</button>

          <button type="submit" name="action" value="target_everything" class="btn btn-secondary">Run everything</button>

          <a href="{% url 'target_lightcurve' id=target.id %}" class="btn btn-info ms-4" title="Interactive light curve viewer">
            <i class="fa fa-line-chart"></i> Light curves
          </a>

          <button type="submit" name="action" value="cleanup_target" class="btn btn-danger ms-4"
                  title="Delete all processing results and configurations">Cleanup</button>

          <!-- Unsafe controls -->
          <button class="btn btn-light collapse-chevron-horizontal collapsed ms-4 me-4" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#unsafeButtons"
                  aria-expanded="false"
                  aria-controls="unsafeButtons"
                  title="Show / hide unsafe controls">
          </button>

          <span id="unsafeButtons" class="collapse collapse-horizontal collapsed">
            <button type="submit" name="action" value="delete_target" class="btn btn-danger"
                    title="Permanently delete this target">Delete target</button>
          </span>

        </fieldset>
      </form>
    {% endif %}


    <!-- Basic info -->
    <hr style="border-style: dotted">
    <div class="row mb-2">
      {% if 'info.log' in files %}
        <div class="col-md">
          {% include "target_block_text.html" with file='info.log' %}
        </div>
      {% endif %}

      <div class="col-md">
        {% if 'target_ra' in target.config and 'target_dec' in target.config %}
          <!-- include Aladin Lite CSS file in the head section of your page -->
          <link rel="stylesheet" href="https://aladin.u-strasbg.fr/AladinLite/api/v3/latest/aladin.min.css" />
          <!-- It seems Aladin uses jQuery 1.x, let's also load it and hope it will not break anything -->
          <script type="text/javascript" src="https://aladin.u-strasbg.fr/AladinLite/api/v3/latest/aladin.js" charset="utf-8"></script>
          {% if not target.celery_id %}
          <script type="text/javascript">
           $(document).ready(function(){
             let aladin;
             A.init.then(() => {
               aladin = A.aladin('#aladin-lite-div', {survey: "P/DSS2/color", fov:0.03, projection: 'TAN'});
               aladin.gotoRaDec({{ target.config.target_ra }}, {{ target.config.target_dec }});
             });
           });
          </script>
          {% endif %}
          <div>
            <!-- insert this snippet where you want Aladin Lite viewer to appear and after the loading of jQuery -->
            <div id="aladin-lite-div"
                 style="min-height:400px; min-width:400px; background-color: lightgray; display: flex; justify-content: center; align-items: center;">
              Aladin Lite is loading...
            </div>
          </div>
          <small>
            {% include "target_block_external.html" with ra=target.config.target_ra dec=target.config.target_dec %}
          </small>

        {% endif %}

        <div class="row">
          {% make_list 'galaxy_map.png' as list %}
          {% for name in list %}
            {% if name in files %}
              <div class="col" style="max-width: 256px">
                {% include "target_block_image.html" with image=name target=target only %}
              </div>
            {% endif %}
          {% endfor %}
        </div>

      </div>

    </div>



    <!-- Survey Data Sources -->
    {# Auto-generated survey sections from registry #}
    {% for source_id, source_config in survey_sources.items %}
      {% if source_config.processing_function and source_id != 'info' %}
        {% with form=survey_forms|get_form:source_id %}
          {% include "survey_section.html" %}
        {% endwith %}
      {% endif %}
    {% endfor %}

  {% endif %}

{% endblock %}
