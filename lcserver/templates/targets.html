{% extends "template.html" %}

{% load el_pagination_tags %}
{% load crispy_forms_tags %}
{% load filters %}

{% block ptitle %}Targets : LCServer{% endblock %}

{% block title %}Targets{% endblock %}

{% block head %}
  <script language="javascript">
   check_menu_visibility = function() {
     var hidden = true;
     var menu = $('#actions_menu');
     var count = 0;

     $('input[name="targets"]').each(function() {
       if ($(this).prop('checked')) {
         hidden = false;
         count += 1;
       }
     });

     if (hidden)
       menu.hide();
     else
       menu.show();
   }

   // Toggle visibility of the menu depending on whether something is selected
   $(function(){
     $('input[name="targets"]').on('change', check_menu_visibility);
     check_menu_visibility();
   });

   // Select all
   $(function(){
     $('input[name="select_all"]').on('change', function() {
       $('input[name="targets"]').prop('checked', $(this).prop('checked'));
       check_menu_visibility();
     });
   });
  </script>
{% endblock %}

{% block content %}

  <div>
    {% crispy form_filter %}
  </div>

  {% if targets %}

    <form action="{% url 'targets_actions' %}" method="POST">
      {% csrf_token %}
      <input type="hidden" name="referer" value="{{ request.path }}?{{ request.GET.urlencode }}"/>

      {% paginate 10 targets %}

      <div class="list-group mb-4">

        <div class="list-group-item d-flex bg-light">
          <input class="form-check-input" type="checkbox" name="select_all" title="Select all"/>
          <span class="ms-auto me-auto"><strong>Target</strong></span>
          <span class="pull-right me-4"><strong>Status</strong></span>
        </div>

        {% for target in targets %}
          <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
            <div class="me-2">
              <input class="form-check-input" type="checkbox" name="targets" value="{{ target.id }}"/>
            </div>
            <div class="ms-1 me-2">
              {{ target.id }}
            </div>
            <div class="ms-2 me-auto">
              <a href="{% url 'targets' id=target.id %}" class="text-decoration-none text-body">
                <div class="fw-bold">{{ target.name }}</div>

                {% if target.title %}
                  <div class="fst-italic">{{ target.title }}</div>
                {% endif %}

                <div>
                  {% if target.config.target_ra or target.config.target_dec %}
                    Target: <span class="fw-bold">{{ target.config.target_ra|to_sexadecimal_hours }} {{ target.config.target_dec|to_sexadecimal_plus }}</span>
                  {% endif %}
                </div>

                <small class="me-2 badge bg-info">{{ target.user|user }}</small>
                <small class="me-2">Created: <span class="fst-italic">{{ target.created|timestamp }}</span></small>
                <small class="me-2">Modified: <span class="fst-italic">{{ target.modified|timestamp }}</span></small>
              </a>
            </div>
            <span class="badge bg-{% if target.state == 'failed' %}danger{% else %}primary{% endif %} rounded-pill">{{ target.state }}</span>
          </div>
        {% endfor %}
      </div>

      <div id='actions_menu' class="mb-4">
        <span class="ms-2 me-2">Actions on selected targets:</span>
        <button type="submit" name="action" value="cleanup" class="btn btn-warning"
                title="Delete all cache and output files, reset to initial state">Cleanup</button>

        <!-- Unsafe controls -->
        <button class="btn btn-light collapse-chevron-horizontal collapsed ms-4 me-4" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#unsafeButtons"
                aria-expanded="false"
                aria-controls="unsafeButtons"
                title="Show / hide unsafe controls">
        </button>

        <span id="unsafeButtons" class="collapse collapse-horizontal collapsed">
          <button type="submit" name="action" value="delete" class="btn btn-danger"
                  title="Permanently delete these targets">Delete</button>
        </span>
      </div>

    </form>

    {% show_pages %}

  {% else %}
    No targets found
  {% endif %}

  <!-- New Target Form at bottom -->
  {% if user.is_authenticated %}
    <hr class="my-4">
    <h3>
      Create New Target
      <span class="span-help-popover float-end" title="Create new target">
        <p>
          You may create new target here. Upon creation, you will be redirected to the dedicated target page, where you may analyze it.
        </p>
      </span>
    </h3>
    {% crispy form_new_target %}
  {% else %}
    <hr class="my-4">
    <p>Please <a href="{% url 'login' %}">log in</a> to create new targets.</p>
  {% endif %}

{% endblock %}
